id: "smtp-credential-stuffing"
name: "SMTP Credential Stuffing Detection"
enabled: false
version: "1.0.0"

# Scheduling
schedule:
  interval: "3h"                      # Run every 3 hours
  lookback: "3h"                      # Analyze logs from the last 3 hours

# Source: reference to global source in config/filters.yaml
source:
  ref: "grafana-prod-dc1"             # Reference to analyzers.sources.*
  query: '{app="tmail"} |= "SMTP Authentication failed"'
  max_lines: 5000

# Extract fields from JSON logs
extraction:
  format: "json"
  fields:
    source_ip: "mdc.remoteIP"
    username: "mdc.username"
    timestamp: "timestamp"

# Detection logic:
# - Group by source_ip
# - Count distinct usernames per IP
# - Alert if 6+ distinct usernames (credential stuffing pattern)
detection:
  groupby: "source_ip"
  distinct: "username"
  threshold: 6
  operator: ">="

# Decision to push to LAPI
decision:
  type: "ban"
  duration: "24h"
  scope: "ip"
  scenario: "crowdsieve/smtp-credential-stuffing"
  reason: "Multiple distinct usernames attempted from single IP"

# Push to all configured LAPI servers
targets:
  - "all"
